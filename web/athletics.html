<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PredictWell Health.ai — Athletics (Pitching Risk)</title>
  <meta name="description" content="PredictWell Athletics: pitcher workload, pain, velocity, rest, and mechanics flags combined into a risk score." />
  <link rel="icon" href="data:," />
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --navy:#0b2545; --brand:#ff7a18;
      --ok:#16a34a; --warn:#ea580c; --err:#dc2626; --card:#ffffff;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background-image:url("/static/images/predictwell_background.png");background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;min-height:100vh;color:var(--ink)}
    .overlay{background:rgba(255,255,255,.92);padding:30px;min-height:100vh}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .brand h1{margin:0;font-size:28px;color:var(--navy)} .brand span{color:var(--brand)}
    nav a{text-decoration:none;color:var(--navy);font-weight:700;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.6);border:1px solid rgba(2,6,23,.1)}
    .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:20px}
    label{display:block;margin-bottom:6px;color:#475569}
    input,textarea{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #cbd5e1;box-sizing:border-box}
    button{padding:10px 16px;font-size:15px;font-weight:700;border-radius:8px;border:none;cursor:pointer}
    .primary{background:var(--brand);color:#fff}.ghost{background:#fff;color:var(--navy);border:1px solid #94a3b8}
    /* Results */
    .results-wrap{display:grid;gap:12px}
    .section{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#fff}
    .section h4{margin:0 0 10px;color:var(--navy);font-size:14px;letter-spacing:.2px;text-transform:uppercase}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .kv{display:flex;justify-content:space-between;gap:12px;border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px}
    .kv b{color:var(--muted);font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .pill.warn{background:#fff7ed;color:var(--warn);border:1px solid #fed7aa}
    .pill.err{background:#fef2f2;color:var(--err);border:1px solid #fecaca}
    .muted{color:var(--muted);font-size:12px}
    details.debug{margin-top:8px}
    pre{background:#0b1220;color:#e2e8f0;padding:14px;border-radius:8px;overflow:auto}
    footer{text-align:center;font-size:12px;color:#475569;margin-top:30px}
    /* Risk bar */
    .risk{display:grid;gap:10px}
    .riskband{position:relative;height:12px;border-radius:999px;overflow:hidden;
      background:linear-gradient(90deg,#22c55e 0%,#f59e0b 50%,#ef4444 100%);}
    .riskpointer{position:absolute;top:-6px;width:0;height:0;
      border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:12px solid #0f172a}
    .risklegend{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    .actions li{margin:4px 0}
  </style>
</head>
<body>
  <div class="overlay">
    <header>
      <div class="brand"><h1>PredictWell <span>Health.ai</span></h1></div>
      <nav>
        <a href="/eldercare.html">Eldercare</a>
        <a href="/athletics.html">Athletics</a>
      </nav>
    </header>

    <div class="card">
      <h2>Pitching Risk — Daily/Weekly Input</h2>

      <label>Pitcher Name</label>
      <input id="p_name" type="text" placeholder="e.g., A. Miller" />

      <label>Age</label>
      <input id="p_age" type="number" min="8" max="60" placeholder="17" />

      <label>Pitch Count (last 7 days)</label>
      <input id="pitch_count_7d" type="number" min="0" step="1" placeholder="92" />

      <label>Innings (last 7 days)</label>
      <input id="innings_7d" type="number" min="0" step="0.1" placeholder="6.2" />

      <label>Rest days since last outing</label>
      <input id="rest_days" type="number" min="0" max="10" step="1" placeholder="2" />

      <label>Avg Velocity (mph)</label>
      <input id="velo_avg" type="number" step="0.1" min="40" max="110" placeholder="84.7" />

      <label>Pain today (0–10)</label>
      <input id="pain_level" type="number" step="1" min="0" max="10" placeholder="2" />

      <label>Throws today</label>
      <input id="workload_today" type="number" step="1" min="0" placeholder="35" />

      <label><input id="elbow_history" type="checkbox" /> Prior elbow or shoulder injury/surgery?</label>

      <label>Mechanics flags (optional)</label>
      <textarea id="mech_flags" placeholder="e.g., late arm, inconsistent stride, drag line anomalies..."></textarea>

      <div>
        <button class="primary" id="riskBtn">Compute Risk</button>
        <button class="ghost" id="pingBtn">Ping Backend</button>
      </div>
    </div>

    <div class="card">
      <h3>Risk Score & Recommendations</h3>
      <div id="resultView" class="results-wrap">
        <p class="muted">Submit to see a friendly summary.</p>
      </div>
      <details class="debug">
        <summary>Raw JSON</summary>
        <pre id="output">{ }</pre>
      </details>
    </div>

    <footer>© <span id="year"></span> PredictWell Health.ai — Athletics</footer>
  </div>

  <script>
    const BASE_API = 'https://predictwell-backend-ai.onrender.com';

    // --- Risk / Actions heuristics ---
    function athleticsRiskScore(d){
      const w = d.workload || {};
      const f = d.flags || {};
      let score = 0;

      // Workload components (0–100 overall)
      if(w.pitch_count_7d) score += Math.min(40, w.pitch_count_7d * 0.3);   // up to ~40
      if(w.innings_7d)     score += Math.min(20, w.innings_7d * 2.5);       // up to ~20
      if(w.rest_days!==undefined && w.rest_days < 3) score += (3 - w.rest_days) * 6; // up to 18
      if(w.pain_level)     score += Math.min(20, w.pain_level * 2.5);       // up to 20
      if(f.elbow_history)  score += 12;
      // Slight bump if velo >= 90 (higher stress context)
      if(w.velo_avg && w.velo_avg >= 90) score += 6;

      score = Math.max(0, Math.min(100, Math.round(score)));
      let band='Low', color='ok';
      if(score >= 66){ band='High'; color='err'; }
      else if(score >= 33){ band='Moderate'; color='warn'; }
      return { score, band, color };
    }

    function athleticsActions(d){
      const w = d.workload || {};
      const f = d.flags || {};
      const a = [];
      if(w.pain_level>=4) a.push('Cease throwing today; ice and monitor pain, reassess tomorrow.');
      if((w.rest_days??0)<2) a.push('Schedule a rest/recovery day (mobility + band work only).');
      if((w.pitch_count_7d??0)>90) a.push('Cap next outing; target low-stress bullpen instead of game load.');
      if(f.elbow_history) a.push('Add pre-throwing warm-up: scap activation + light band series.');
      if((w.velo_avg??0)>=90) a.push('Increase post-throw shoulder care (sleeper stretch, posterior cuff).');
      if(!a.length) a.push('Proceed as planned with standard warm-up and 48h recovery window.');
      return a.slice(0,5);
    }

    function renderAthleticsView(data){
      const wrap = document.getElementById('resultView');
      if(!data){ wrap.innerHTML = '<p class="muted">No data.</p>'; return; }

      const y = (v,s='') => (v===null||v===undefined||v==='')?'—':(s?`${v}${s}`:v);
      const painPill = (n)=>{
        if(n>=7) return `<span class="pill err">Pain: ${n}/10</span>`;
        if(n>=4) return `<span class="pill warn">Pain: ${n}/10</span>`;
        return `<span class="pill ok">Pain: ${n}/10</span>`;
      };
      const elbowPill = (on)=>`<span class="pill ${on?'warn':'ok'}">Elbow/Shoulder: ${on?'History':'None'}</span>`;

      const w = data.workload || {};
      const f = data.flags || {};
      const ts = data.timestamp ? new Date(data.timestamp).toLocaleString() : '—';
      const risk = athleticsRiskScore(data);
      const actions = athleticsActions(data);

      wrap.innerHTML = `
        <div class="section">
          <h4>Risk Summary</h4>
          <div class="risk">
            <div class="riskband">
              <div class="riskpointer" style="left: calc(${risk.score}% - 7px)"></div>
            </div>
            <div class="risklegend"><span>Low</span><span>Moderate</span><span>High</span></div>
            <div class="kv" style="margin-top:6px"><b>Score</b><span><span class="pill ${risk.color}">${risk.band}</span> &nbsp; ${risk.score}/100</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Summary</h4>
          <div class="grid">
            <div class="kv"><b>Pitcher</b><span>${y(data.name)}</span></div>
            <div class="kv"><b>Age</b><span>${y(data.age)}</span></div>
            <div class="kv"><b>Record ID</b><span>${y(data.id)}</span></div>
            <div class="kv"><b>Submitted</b><span>${ts}</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Workload (7d + Today)</h4>
          <div class="grid">
            <div class="kv"><b>Pitch Count (7d)</b><span>${y(w.pitch_count_7d)}</span></div>
            <div class="kv"><b>Innings (7d)</b><span>${y(w.innings_7d)}</span></div>
            <div class="kv"><b>Throws Today</b><span>${y(w.workload_today)}</span></div>
            <div class="kv"><b>Rest Days</b><span>${y(w.rest_days)}</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Health & Performance</h4>
          <div class="grid">
            <div>${painPill(Number(w.pain_level||0))}</div>
            <div class="kv"><b>Velocity (avg)</b><span>${y(w.velo_avg,' mph')}</span></div>
            <div>${elbowPill(!!f.elbow_history)}</div>
          </div>
        </div>

        <div class="section">
          <h4>Next Actions</h4>
          <ul class="actions">
            ${actions.map(a=>`<li>${a}</li>`).join('')}
          </ul>
        </div>

        <div class="section">
          <h4>Mechanics Notes</h4>
          <div class="kv" style="grid-column:1/-1"><b>Notes</b><span>${y(f.mechanics_notes)}</span></div>
        </div>
      `;
    }

    const out = (obj) => {
      const el = document.getElementById('output');
      el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    };

    async function ping(){
      try{
        const r = await fetch(`${BASE_API}/healthz`, { cache:'no-store' });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        out(await r.json());
      }catch(e){ out({error:String(e)}); }
    }

    // Submit and show friendly summary + risk immediately
    async function computeRisk(){
      const payload = {
        name: document.getElementById('p_name').value,
        age: Number(document.getElementById('p_age').value),
        workload: {
          pitch_count_7d: Number(document.getElementById('pitch_count_7d').value),
          innings_7d: Number(document.getElementById('innings_7d').value),
          rest_days: Number(document.getElementById('rest_days').value),
          velo_avg: Number(document.getElementById('velo_avg').value),
          pain_level: Number(document.getElementById('pain_level').value),
          workload_today: Number(document.getElementById('workload_today').value)
        },
        flags: {
          elbow_history: document.getElementById('elbow_history').checked,
          mechanics_notes: document.getElementById('mech_flags').value
        },
        timestamp: new Date().toISOString()
      };

      try{
        renderAthleticsView(payload); // optimistic preview
        const res = await fetch(`${BASE_API}/risk`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const server = await res.json(); // { id }
        const display = { id: server?.id ?? null, ...payload };
        renderAthleticsView(display);
        out(display);
      }catch(err){
        renderAthleticsView(null);
        out({error:String(err)});
      }
    }

    document.getElementById('riskBtn').addEventListener('click', computeRisk);
    document.getElementById('pingBtn').addEventListener('click', ping);
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
