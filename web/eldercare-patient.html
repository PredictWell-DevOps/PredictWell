<!-- ====== eldercare-patient.html (Patient Portal — 12-input + client-side score + AI result tiles) ====== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PredictWell Health.ai — Eldercare Patient Portal</title>
  <meta name="description" content="Simple 12-question checkup for seniors and caregivers. Instant score + AI insights." />
  <link rel="icon" href="data:,">
  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.78);
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,0.18);
      --blu:#2563eb; --ink:#0b1020; --muted:#374151; --line: rgba(17,24,39,0.08);
      --ok:#10b981; --warn:#f59e0b; --risk:#ef4444;
    }
    html, body { height:100%; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; color:#0b1020; }
    body {
      min-height:100vh;
      background:
        linear-gradient(0deg, rgba(5,10,20,0.55), rgba(5,10,20,0.55)),
        url("/static/images/predictwell_background.png") center/cover no-repeat fixed;
      display:flex; flex-direction:column;
    }
    header {
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
      background: rgba(255,255,255,0.65);
      border-bottom:1px solid var(--line);
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 12px 18px; display:flex; align-items:center; gap:16px; }
    .brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--ink); font-weight:700; }
    .brand span { font-size:18px; letter-spacing:.2px; }
    .main { flex:1; display:flex; align-items:flex-start; justify-content:center; padding: 28px 16px 60px; }
    .card {
      width:100%; max-width:980px; background:var(--glass-bg); backdrop-filter: blur(6px);
      box-shadow: var(--shadow); border-radius: var(--radius); border:1px solid var(--line);
      padding:18px;
    }
    h1 { margin: 8px 0 2px; font-size: 22px; }
    p.sub { margin-top:0; color:var(--muted); font-size: 14px; }
    form { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top: 10px; }
    label { font-size:13px; color:#111827; }
    input[type="number"], select {
      width:100%; height:42px; border-radius:12px; border:1px solid var(--line); padding:0 12px; background:#fff;
    }
    .row-span-2 { grid-column: 1 / -1; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:46px; border-radius:14px; padding:0 16px; cursor:pointer; border:0;
      background: linear-gradient(90deg, #1d4ed8, #60a5fa); color:white; font-weight:700;
      box-shadow: 0 8px 24px rgba(37,99,235,.25);
    }
    .btn:active { transform: translateY(1px); }
    .grid-tiles {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:14px;
    }
    .tile {
      background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px;
    }
    .tile h3 { margin:0 0 6px; font-size:16px; }
    .metric { font-size:28px; font-weight:800; margin: 4px 0 2px; }
    .ok { color: var(--ok); } .warn{ color: var(--warn);} .risk{ color: var(--risk); }
    .badge {
      display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; background:#111827; color:#fff;
    }
    .results {
      background:#fff; border:1px dashed var(--line); border-radius:14px; padding:14px; margin-top:12px; white-space:pre-wrap; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:13px;
    }
    footer { text-align:center; color:#9ca3af; font-size:12px; padding:20px 0 34px; }
    @media (max-width:520px){
      h1 { font-size:20px; }
      .metric { font-size:24px; }
    }
  </style>
</head>
<body>
  <!-- Header (logo links back to homepage) -->
  <header>
    <div class="wrap">
      <a class="brand" href="/index.html" title="Back to Home">
        <span>PredictWell<span style="font-weight:400">Health</span>.ai</span>
      </a>
      <div style="margin-left:auto;">
        <span class="badge" id="healthz">checking…</span>
      </div>
    </div>
  </header>

  <main class="main">
    <section class="card">
      <h1>Patient Checkup — 12 Quick Questions</h1>
      <p class="sub">Answer these to get your PredictWell Score and AI risk outlook. Your doctor can review these results.</p>

      <!-- 12-input form (IDs preserved for compatibility) -->
      <form id="pwForm">
        <div>
          <label>Age</label>
          <input id="age" type="number" min="0" max="120" required />
        </div>
        <div>
          <label>Living Situation</label>
          <select id="living">
            <option value="alone">Alone</option>
            <option value="with_family">With family</option>
            <option value="assisted">Assisted living</option>
          </select>
        </div>
        <div>
          <label>Falls in last 12 months?</label>
          <select id="falls_12m"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Feel unsteady when walking?</label>
          <select id="unsteady"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Fear of falling?</label>
          <select id="fear_fall"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Chair rise difficulty?</label>
          <select id="chair_rise"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Dizziness?</label>
          <select id="dizzy"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Medication count</label>
          <input id="med_count" type="number" min="0" />
        </div>
        <div>
          <label>Memory concerns?</label>
          <select id="memory"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Mood concerns?</label>
          <select id="mood"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Weekly activity level</label>
          <select id="activity">
            <option value="low">Low</option>
            <option value="moderate">Moderate</option>
            <option value="high">High</option>
          </select>
        </div>
        <div>
          <label>Home hazards present?</label>
          <select id="home_haz"><option>No</option><option>Yes</option></select>
        </div>

        <div class="row-span-2" style="display:flex; gap:10px; margin-top:4px;">
          <button type="button" class="btn" id="getResultsBtn">Get Results</button>
          <button type="button" class="btn" style="background:linear-gradient(90deg,#6b7280,#9ca3af)" id="clearBtn" title="Clear and reset">Clear</button>
        </div>
      </form>

      <!-- Score badge + AI tiles -->
      <div class="grid-tiles" style="margin-top:10px;">
        <div class="tile">
          <h3>Your PredictWell Score</h3>
          <div id="scoreNum" class="metric">—</div>
          <div id="scoreTag" class="badge">pending</div>
        </div>

        <div class="tile">
          <h3>AI Risk — Current</h3>
          <div id="aiNow" class="metric">—</div>
          <div id="aiNowNote" class="sub" style="margin:4px 0 0;">&nbsp;</div>
        </div>

        <div class="tile">
          <h3>AI Risk — In 2 Weeks</h3>
          <div id="ai2w" class="metric">—</div>
          <div id="ai2wNote" class="sub" style="margin:4px 0 0;">&nbsp;</div>
        </div>

        <div class="tile">
          <h3>AI Risk — In 4 Weeks</h3>
          <div id="ai4w" class="metric">—</div>
          <div id="ai4wNote" class="sub" style="margin:4px 0 0;">&nbsp;</div>
        </div>
      </div>

      <!-- Raw server reply (for transparency / debugging) -->
      <div id="serverOut" class="results" hidden></div>
    </section>
  </main>

  <footer>© PredictWell Health.ai</footer>

  <script>
    // ===== Config =====
    const BASE_API = 'https://predictwell-backend-ai.onrender.com';

    // ===== Health check badge =====
    (async () => {
      try {
        const r = await fetch(BASE_API + '/healthz', { cache: 'no-store' });
        const j = await r.json();
        document.getElementById('healthz').textContent = j.status === 'ok' ? 'backend: ok' : 'backend: ?';
      } catch(e) {
        document.getElementById('healthz').textContent = 'backend: offline';
      }
    })();

    // ===== Local storage load/save (keep IDs as-is) =====
    const LS_KEY = 'eldercare_patient12';
    function loadSaved(){
      try {
        const x = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
        for (const k of ['age','living','falls_12m','unsteady','fear_fall','chair_rise','dizzy','med_count','memory','mood','activity','home_haz']){
          if (x[k] !== undefined) document.getElementById(k).value = x[k];
        }
      } catch(_) {}
    }
    function saveCurrent(){
      const data = {};
      for (const k of ['age','living','falls_12m','unsteady','fear_fall','chair_rise','dizzy','med_count','memory','mood','activity','home_haz']){
        data[k] = document.getElementById(k).value;
      }
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      return data;
    }
    loadSaved();

    // ===== Simple client-side score (unchanged spirit) =====
    function computeLocalScore(data){
      // Lightweight heuristic to preserve existing behavior
      let score = 100;
      const yes = v => String(v).toLowerCase() === 'yes';
      score -= Math.min(30, Number(data.med_count||0) * 2);
      if (yes(data.falls_12m)) score -= 25;
      if (yes(data.unsteady))  score -= 15;
      if (yes(data.fear_fall)) score -= 10;
      if (yes(data.chair_rise)) score -= 10;
      if (yes(data.dizzy)) score -= 10;
      if (yes(data.memory)) score -= 10;
      if (yes(data.mood)) score -= 8;
      if ((data.activity||'low') === 'low') score -= 6;
      if (yes(data.home_haz)) score -= 6;
      score = Math.max(0, Math.min(100, score));
      return score;
    }
    function setScoreBadge(score){
      const num = document.getElementById('scoreNum');
      const tag = document.getElementById('scoreTag');
      num.textContent = String(score);
      let cls = 'ok', label = 'LOW';
      if (score < 35){ cls='risk'; label='HIGH'; }
      else if (score < 70){ cls='warn'; label='MODERATE'; }
      tag.className = 'badge ' + cls;
      tag.textContent = label;
      num.className = 'metric ' + cls;
    }

    // ===== Robust AI Results renderer (handles multiple JSON shapes) =====
    function pick(obj, pathArr){
      for (const p of pathArr){
        const val = p.split('.').reduce((o,k)=> (o && k in o) ? o[k] : undefined, obj ?? {});
        if (val !== undefined && val !== null) return val;
      }
      return undefined;
    }

    function renderAiResults(resp){
      // Try common shapes:
      // A) { risk: { current, two_weeks, four_weeks, notes:{...} } }
      // B) { current, risk_2w, risk_4w }
      // C) { forecast: [{timeframe:'current', score, note}, ...] }
      // D) { now, in2w, in4w }
      const cur = pick(resp, ['risk.current','current','now','risk_now','forecast.0.score']);
      const two = pick(resp, ['risk.two_weeks','two_weeks','risk_2w','in2w','forecast.1.score']);
      const four = pick(resp, ['risk.four_weeks','four_weeks','risk_4w','in4w','forecast.2.score']);

      const curNote = pick(resp, ['risk.notes.current','notes.current','forecast.0.note','note_now']);
      const twoNote = pick(resp, ['risk.notes.two_weeks','notes.two_weeks','forecast.1.note','note_2w']);
      const fourNote = pick(resp, ['risk.notes.four_weeks','notes.four_weeks','forecast.2.note','note_4w']);

      setTile('aiNow','aiNowNote', cur, curNote);
      setTile('ai2w','ai2wNote', two, twoNote);
      setTile('ai4w','ai4wNote', four, fourNote);
    }

    function setTile(scoreId, noteId, val, note){
      const el = document.getElementById(scoreId);
      const nt = document.getElementById(noteId);
      if (val === undefined || val === null || val === ''){
        el.textContent = '—';
        el.className = 'metric';
        nt.textContent = '';
        return;
      }
      const num = Number(val);
      if (Number.isFinite(num)){
        el.textContent = String(num);
        let cls = 'ok';
        if (num < 35) cls = 'risk';
        else if (num < 70) cls = 'warn';
        el.className = 'metric ' + cls;
      } else {
        el.textContent = String(val);
        el.className = 'metric';
      }
      nt.textContent = note ? String(note) : '';
    }

    // ===== Submit handler =====
    async function handleSubmit(){
      const data = saveCurrent();
      const localScore = computeLocalScore(data);
      setScoreBadge(localScore);

      // POST to backend and merge response
      try{
        const r = await fetch(BASE_API + '/eldercare/checkin', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ source:'patient_portal', inputs:data, client_score: localScore })
        });
        const j = await r.json();

        // Show raw server (toggleable)
        const out = document.getElementById('serverOut');
        out.hidden = false;
        out.textContent = JSON.stringify(j, null, 2);

        // Render AI risk tiles
        renderAiResults(j);
      }catch(e){
        const out = document.getElementById('serverOut');
        out.hidden = false;
        out.textContent = 'Server error. Please try again shortly.';
      }
    }

    // ===== Wire buttons =====
    document.getElementById('getResultsBtn').addEventListener('click', handleSubmit);
    document.getElementById('clearBtn').addEventListener('click', () => {
      localStorage.removeItem(LS_KEY);
      for (const k of ['age','living','falls_12m','unsteady','fear_fall','chair_rise','dizzy','med_count','memory','mood','activity','home_haz']){
        const el = document.getElementById(k);
        if (el.tagName === 'INPUT') el.value = '';
        else el.selectedIndex = 0;
      }
      document.getElementById('scoreNum').textContent='—';
      document.getElementById('scoreTag').textContent='pending';
      for (const id of ['aiNow','ai2w','ai4w']){ document.getElementById(id).textContent='—'; document.getElementById(id).className='metric'; }
      for (const id of ['aiNowNote','ai2wNote','ai4wNote']){ document.getElementById(id).textContent=''; }
      const out = document.getElementById('serverOut'); out.hidden = true; out.textContent = '';
    });
  </script>
</body>
</html>
