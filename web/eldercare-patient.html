<!-- ====== eldercare-patient.html (Patient Portal — 12-input + client-side score + visual badge) ====== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PredictWell Health.ai — Eldercare Patient Portal</title>
  <meta name="description" content="Simple 12-question checkup for seniors and caregivers. Instant score + AI insights." />
  <link rel="icon" href="data:,">
  <style>
    /* ---------- Theme ---------- */
    :root{
      --glass: rgba(255,255,255,0.78);
      --ink:#0b1020; --muted:#374151; --line: rgba(17,24,39,0.08);
      --pri:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --card-radius: 18px; --shadow: 0 10px 30px rgba(0,0,0,0.18);
      --blur: blur(8px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        linear-gradient(180deg, rgba(10,14,30,0.65) 0%, rgba(10,14,30,0.35) 40%, rgba(10,14,30,0.2) 100%),
        url("/static/images/predictwell_background.png") center/cover fixed no-repeat;
    }

    /* ---------- Header / Nav ---------- */
    .header{
      position:sticky; top:0; z-index:1000;
      backdrop-filter: var(--blur);
      background: rgba(10,14,30,0.55);
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .nav{
      max-width:1100px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; text-decoration:none;
      color:#fff; font-weight:700; letter-spacing:.2px;
    }
    .brand .dot{opacity:.9; font-weight:800}
    .menu{display:flex; gap:10px; align-items:center}
    .menu a, .menu button{
      appearance:none; border:1px solid rgba(255,255,255,0.18);
      background: transparent; color:#fff; padding:8px 12px; border-radius:12px;
      font-weight:600; cursor:pointer; text-decoration:none;
    }
    .hamburger{display:none}
    @media (max-width:820px){
      .menu-links{display:none}
      .hamburger{display:inline-flex}
      .menu.open .menu-links{display:flex; flex-direction:column; position:absolute; right:16px; top:58px;
        background: rgba(10,14,30,0.85); border:1px solid rgba(255,255,255,0.15); border-radius:14px; padding:10px; gap:8px}
    }

    /* ---------- Layout ---------- */
    .wrap{max-width:1100px; margin:20px auto 60px; padding:0 16px}
    .hero{
      margin-top:18px; margin-bottom:18px;
      display:grid; gap:14px;
      grid-template-columns: 1fr;
    }

    .card{
      background: var(--glass);
      border:1px solid var(--line);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      backdrop-filter: saturate(140%) blur(3px);
    }
    .card .pad{padding:18px}

    .title{
      font-weight:800; font-size:clamp(24px, 3.2vw, 34px); margin:0 0 6px 0; color:#0b1225;
    }
    .subtitle{
      margin:0 0 12px 0; color:var(--muted); font-size:clamp(14px,2.1vw,16px);
    }

    /* ---------- Form ---------- */
    form{display:grid; gap:12px}
    .row{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }

    label{font-weight:700; font-size:14px}
    .hint{font-size:12px; color:#4b5563}
    input[type="number"], select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d1d5db; background:#fff; font-size:15px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px; font-weight:800; font-size:15px; cursor:pointer; border:0;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9 55%, #0ea5e9);
      color:white;
    }
    .btn.secondary{
      background: linear-gradient(135deg, #fbbf24, #f59e0b 55%, #f59e0b);
      color:#111827;
    }
    .btn.ghost{
      background:transparent; color:#0f172a; border:1px solid #cbd5e1;
    }

    /* ---------- Results ---------- */
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:800; border:1px solid #e5e7eb;
      background:#fff;
    }
    .b-low{color:var(--ok); border-color:#bbf7d0; background:#f0fdf4}
    .b-mod{color:var(--warn); border-color:#fde68a; background:#fffbeb}
    .b-high{color:var(--bad); border-color:#fecaca; background:#fef2f2}

    .grid-2{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }

    pre{
      background:#0b1225; color:#e5e7eb; padding:14px; border-radius:14px; overflow:auto; font-size:12.5px
    }

    /* ---------- Footer note ---------- */
    .tiny{font-size:12px; color:#475569}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav">
      <a class="brand" href="/index.html" title="Back to homepage">
        <span style="display:inline-flex; width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,#38bdf8,#0ea5e9)"></span>
        <span>P R E D I C T W E L L <span class="dot">.ai</span></span>
      </a>
      <div class="menu" id="menu">
        <div class="menu-links">
          <a href="/eldercare.html">Eldercare Doctors</a>
          <a href="/eldercare-patient.html">Eldercare Patients</a>
          <a href="/athletics.html">Athletics Doctors</a>
          <a href="/athletics-patient.html">Athletics Patients</a>
          <a href="/index.html#contact">Contact</a>
        </div>
        <button class="hamburger" aria-label="Menu" onclick="toggleMenu()">☰</button>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <!-- Intro -->
    <section class="hero">
      <div class="card">
        <div class="pad">
          <h1 class="title">Eldercare Patient Checkup</h1>
          <p class="subtitle">Answer 12 quick questions to get an instant <strong>PredictWell Score</strong> and simple, actionable tips. Your doctor can also review the results.</p>
          <div id="healthBadge" class="badge" title="Backend status">Backend: checking…</div>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="card">
      <div class="pad">
        <form id="patientForm" onsubmit="event.preventDefault(); handleResults();">
          <!-- Row 1 -->
          <div class="row">
            <div>
              <label for="age">Age</label>
              <input id="age" name="age" type="number" inputmode="numeric" min="50" max="110" placeholder="e.g., 79" required>
              <div class="hint">Ages 65+ have higher baseline risk</div>
            </div>
            <div>
              <label for="living">Living Situation</label>
              <select id="living" name="living" required>
                <option value="" selected disabled>Select one</option>
                <option value="alone">Alone</option>
                <option value="with_family">With family/partner</option>
                <option value="assisted">Assisted living</option>
                <option value="facility">Skilled nursing facility</option>
              </select>
            </div>
          </div>

          <!-- Row 2 -->
          <div class="row">
            <div>
              <label for="falls_12m">Any falls in the last 12 months?</label>
              <select id="falls_12m" name="falls_12m" required>
                <option value="" selected disabled>Select one</option>
                <option value="0">No falls</option>
                <option value="1">1 fall</option>
                <option value="2plus">2 or more falls</option>
              </select>
            </div>
            <div>
              <label for="unsteady">Do you feel unsteady when walking?</label>
              <select id="unsteady" name="unsteady" required>
                <option value="" selected disabled>Select one</option>
                <option value="no">No</option>
                <option value="sometimes">Sometimes</option>
                <option value="often">Often</option>
              </select>
            </div>
          </div>

          <!-- Row 3 -->
          <div class="row">
            <div>
              <label for="fear_fall">Are you afraid of falling?</label>
              <select id="fear_fall" name="fear_fall" required>
                <option value="" selected disabled>Select one</option>
                <option value="no">No</option>
                <option value="a_little">A little</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div>
              <label for="chair_rise">Can you stand from a chair without using your hands?</label>
              <select id="chair_rise" name="chair_rise" required>
                <option value="" selected disabled>Select one</option>
                <option value="yes">Yes</option>
                <option value="hard">Hard</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>

          <!-- Row 4 -->
          <div class="row">
            <div>
              <label for="dizzy">Dizziness or lightheaded recently?</label>
              <select id="dizzy" name="dizzy" required>
                <option value="" selected disabled>Select one</option>
                <option value="no">No</option>
                <option value="occasional">Occasional</option>
                <option value="frequent">Frequent</option>
              </select>
            </div>
            <div>
              <label for="med_count">How many daily medications?</label>
              <select id="med_count" name="med_count" required>
                <option value="" selected disabled>Select one</option>
                <option value="0-3">0–3</option>
                <option value="4-7">4–7</option>
                <option value="8+">8+</option>
              </select>
            </div>
          </div>

          <!-- Row 5 -->
          <div class="row">
            <div>
              <label for="memory">Any memory concerns?</label>
              <select id="memory" name="memory" required>
                <option value="" selected disabled>Select one</option>
                <option value="no">No</option>
                <option value="mild">Mild forgetfulness</option>
                <option value="significant">Significant concern</option>
              </select>
            </div>
            <div>
              <label for="mood">Feeling down, depressed, or little interest?</label>
              <select id="mood" name="mood" required>
                <option value="" selected disabled>Select one</option>
                <option value="no">No</option>
                <option value="sometimes">Sometimes</option>
                <option value="often">Often</option>
              </select>
            </div>
          </div>

          <!-- Row 6 -->
          <div class="row">
            <div>
              <label for="activity">Weekly activity level</label>
              <select id="activity" name="activity" required>
                <option value="" selected disabled>Select one</option>
                <option value="low">Low (rare walks/exercise)</option>
                <option value="moderate">Moderate (2–3x/week)</option>
                <option value="high">High (4+ x/week)</option>
              </select>
            </div>
            <div>
              <label for="home_haz">Home hazards (loose rugs, poor lighting, clutter)?</label>
              <select id="home_haz" name="home_haz" required>
                <option value="" selected disabled>Select one</option>
                <option value="none">None</option>
                <option value="some">Some</option>
                <option value="many">Many</option>
              </select>
            </div>
          </div>

          <!-- Actions -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">
            <button class="btn" id="goBtn" type="submit">Get Results</button>
            <button class="btn secondary" type="button" onclick="saveForm()">Save for Later</button>
            <button class="btn ghost" type="button" onclick="clearForm()">Clear</button>
          </div>
          <p class="tiny" style="margin-top:8px">Your answers are stored locally on this device only (using your browser’s storage) until you submit to your doctor.</p>
        </form>
      </div>
    </section>

    <!-- Results -->
    <section style="margin-top:14px" class="grid-2">
      <div class="card">
        <div class="pad">
          <h2 class="title" style="font-size:22px; margin-bottom:8px">Your PredictWell Score</h2>
          <div id="scoreBadge" class="badge">No score yet</div>
          <p id="scoreNote" class="subtitle" style="margin-top:10px"></p>
          <h3 style="margin:12px 0 6px 0">Top Suggestions</h3>
          <ul id="tips" style="margin:0 0 6px 18px; padding:0"></ul>
          <p class="tiny">Seek urgent care for severe dizziness, chest pain, shortness of breath, confusion, or new weakness.</p>
        </div>
      </div>
      <div class="card">
        <div class="pad">
          <h2 class="title" style="font-size:22px; margin-bottom:8px">AI Analysis (from server)</h2>
          <p class="subtitle">We’ll send your answers to the PredictWell server and show any additional insights below.</p>
          <pre id="serverOut">— No server response yet —</pre>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ========= CONFIG =========
    const STORAGE_KEY = 'eldercare_patient12';
    const BASE_API = 'https://predictwell-backend-ai.onrender.com';

    // ========= NAV =========
    function toggleMenu(){ document.getElementById('menu').classList.toggle('open'); }

    // ========= STORAGE =========
    function saveForm(){
      const data = readForm();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      toast('Saved on this device.');
    }
    function loadForm(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        for(const [k,v] of Object.entries(d)){
          const el = document.getElementById(k);
          if(el) el.value = v;
        }
      }catch(e){}
    }
    function clearForm(){
      document.getElementById('patientForm').reset();
      localStorage.removeItem(STORAGE_KEY);
      setScoreUI(null);
      document.getElementById('serverOut').textContent = '— No server response yet —';
      toast('Cleared.');
    }

    function readForm(){
      const ids = ["age","living","falls_12m","unsteady","fear_fall","chair_rise","dizzy","med_count","memory","mood","activity","home_haz"];
      const out = {};
      ids.forEach(id=>{
        const el = document.getElementById(id);
        out[id] = el ? el.value : null;
      });
      return out;
    }

    // ========= SCORING (client-side) =========
    function scorePatient(d){
      // Simple additive risk model (0–100). This is patient-facing, conservative.
      let s = 0;

      const age = Number(d.age||0);
      if(age >= 85) s += 22;
      else if(age >= 80) s += 18;
      else if(age >= 75) s += 14;
      else if(age >= 70) s += 10;
      else if(age >= 65) s += 6;

      if(d.falls_12m === '1') s += 14;
      if(d.falls_12m === '2plus') s += 24;

      if(d.unsteady === 'sometimes') s += 10;
      if(d.unsteady === 'often') s += 18;

      if(d.fear_fall === 'a_little') s += 6;
      if(d.fear_fall === 'yes') s += 12;

      if(d.chair_rise === 'hard') s += 10;
      if(d.chair_rise === 'no') s += 18;

      if(d.dizzy === 'occasional') s += 8;
      if(d.dizzy === 'frequent') s += 16;

      if(d.med_count === '4-7') s += 8;
      if(d.med_count === '8+') s += 16;

      if(d.memory === 'mild') s += 6;
      if(d.memory === 'significant') s += 14;

      if(d.mood === 'sometimes') s += 6;
      if(d.mood === 'often') s += 12;

      if(d.activity === 'low') s += 10;
      if(d.activity === 'moderate') s += 4;

      if(d.home_haz === 'some') s += 6;
      if(d.home_haz === 'many') s += 12;

      // Clamp 0–100
      s = Math.max(0, Math.min(100, s));
      let level='low', label='Low', note='Great! Keep up healthy habits.';
      if(s>=30 && s<60){ level='mod'; label='Moderate'; note='Some areas to improve—see tips below.'; }
      if(s>=60){ level='high'; label='High'; note='Consider contacting your clinician to reduce risks.'; }
      return {score:s, level, label, note};
    }

    function buildTips(d){
      const tips = [];
      // Personalize top suggestions (max 5)
      if(d.falls_12m !== '0' || d.unsteady !== 'no'){ tips.push('Ask your clinician about balance & strength exercises (e.g., Tai Chi).'); }
      if(d.home_haz !== 'none'){ tips.push('Remove home hazards: secure rugs, improve lighting, clear walkways, add grab bars.'); }
      if(d.med_count === '8+' || d.dizzy !== 'no'){ tips.push('Request a medication review to check for side effects like dizziness.'); }
      if(d.activity === 'low'){ tips.push('Start short daily walks (5–10 min) and slowly increase time each week.'); }
      if(d.memory !== 'no'){ tips.push('Bring a family member to visits and keep a simple notes journal for memory cues.'); }
      if(d.mood !== 'no'){ tips.push('Talk to your clinician about mood—brief screening and support can help.'); }
      if(tips.length===0){ tips.push('Keep doing what works—routine activity, hydration, and home safety checks.'); }
      return tips.slice(0,5);
    }

    function setScoreUI(res){
      const badge = document.getElementById('scoreBadge');
      const note = document.getElementById('scoreNote');
      const tipsEl = document.getElementById('tips');
      tipsEl.innerHTML = '';

      if(!res){
        badge.className = 'badge';
        badge.textContent = 'No score yet';
        note.textContent = '';
        return;
      }
      const cls = res.level==='high' ? 'b-high' : (res.level==='mod' ? 'b-mod' : 'b-low');
      badge.className = 'badge ' + cls;
      badge.textContent = `${res.label} Risk — Score ${res.score}/100`;
      note.textContent = res.note;
    }

    async function handleResults(){
      const data = readForm();
      // Basic front-end validation
      for(const [k,v] of Object.entries(data)){
        if(!v){ toast('Please complete all questions.'); return; }
      }

      // 1) Client-side score
      const client = scorePatient(data);
      setScoreUI(client);

      // Suggestions
      const tips = buildTips(data);
      const tipsEl = document.getElementById('tips');
      tipsEl.innerHTML = tips.map(t=>`<li>${t}</li>`).join('');

      // 2) Save locally
      saveForm();

      // 3) Send to backend (/eldercare/checkin)
      try{
        document.getElementById('goBtn').disabled = true;
        const resp = await fetch(`${BASE_API}/eldercare/checkin`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            source: 'patient_portal_v1',
            checkin_type: 'patient_simple12',
            inputs: data,
            client_score: client
          })
        });
        const text = await resp.text();
        // Try to parse JSON; if not JSON, show raw
        try{
          const json = JSON.parse(text);
          document.getElementById('serverOut').textContent = JSON.stringify(json, null, 2);
          // If server returns a refined risk, reflect it (optional merge)
          if(json && json.overall && typeof json.overall.score === 'number'){
            setScoreUI({
              score: Math.round(json.overall.score),
              level: json.overall.level || client.level,
              label: (json.overall.level ? cap(json.overall.level) : client.label),
              note: json.overall.note || client.note
            });
          }
        }catch{
          document.getElementById('serverOut').textContent = text || '(empty response)';
        }
      }catch(err){
        document.getElementById('serverOut').textContent = `Error contacting server: ${err}`;
      }finally{
        document.getElementById('goBtn').disabled = false;
      }
    }

    function cap(s){ return String(s||'').slice(0,1).toUpperCase() + String(s||'').slice(1); }

    // ========= BACKEND HEALTH BADGE =========
    async function pollHealth(){
      const el = document.getElementById('healthBadge');
      try{
        const r = await fetch(`${BASE_API}/healthz`, {cache:'no-store'});
        if(!r.ok) throw new Error(r.status+'');
        const j = await r.json();
        if(j && j.status === 'ok'){
          el.className = 'badge b-low';
          el.textContent = 'Backend: online';
        }else{
          el.className = 'badge b-mod';
          el.textContent = 'Backend: waking…';
        }
      }catch{
        el.className = 'badge b-mod';
        el.textContent = 'Backend: waking…';
      }
    }

    function toast(msg){
      // lightweight toast
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.position='fixed'; t.style.bottom='18px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
      t.style.background='#111827'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='12px';
      t.style.boxShadow='0 6px 20px rgba(0,0,0,.25)'; t.style.zIndex='2000'; t.style.fontWeight='700';
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .35s'; setTimeout(()=>t.remove(), 400); }, 1200);
    }

    // Init
    loadForm();
    pollHealth();
    setInterval(pollHealth, 60000); // recheck each minute
  </script>
</body>
</html>
