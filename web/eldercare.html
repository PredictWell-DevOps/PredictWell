<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PredictWell Health.ai — Eldercare Sentinel</title>
  <meta name="description" content="PredictWell Eldercare Sentinel: preventive health signals, check-ins, and gentle daily actions." />
  <link rel="icon" href="data:," />
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --navy:#0b2545; --brand:#ff7a18;
      --ok:#16a34a; --warn:#ea580c; --err:#dc2626; --card:#ffffff;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background-image:url("/static/images/predictwell_background.png");background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;min-height:100vh;color:var(--ink)}
    .overlay{background:rgba(255,255,255,.92);padding:30px;min-height:100vh}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .brand h1{margin:0;font-size:28px;color:var(--navy)} .brand span{color:var(--brand)}
    nav a{text-decoration:none;color:var(--navy);font-weight:700;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.6);border:1px solid rgba(2,6,23,.1)}
    .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:20px}
    label{display:block;margin-bottom:6px;color:#475569}
    input,textarea{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #cbd5e1;box-sizing:border-box}
    button{padding:10px 16px;font-size:15px;font-weight:700;border-radius:8px;border:none;cursor:pointer}
    .primary{background:var(--brand);color:#fff}.ghost{background:#fff;color:var(--navy);border:1px solid #94a3b8}
    /* Results layout */
    .results-wrap{display:grid;gap:12px}
    .section{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#fff}
    .section h4{margin:0 0 10px;color:var(--navy);font-size:14px;letter-spacing:.2px;text-transform:uppercase}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .kv{display:flex;justify-content:space-between;gap:12px;border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px}
    .kv b{color:var(--muted);font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .pill.warn{background:#fff7ed;color:var(--warn);border:1px solid #fed7aa}
    .pill.err{background:#fef2f2;color:var(--err);border:1px solid #fecaca}
    .muted{color:var(--muted);font-size:12px}
    details.debug{margin-top:8px}
    pre{background:#0b1220;color:#e2e8f0;padding:14px;border-radius:8px;overflow:auto}
    footer{text-align:center;font-size:12px;color:#475569;margin-top:30px}
    /* Risk bar */
    .risk{display:grid;gap:10px}
    .riskband{position:relative;height:12px;border-radius:999px;overflow:hidden;
      background:linear-gradient(90deg,#22c55e 0%,#f59e0b 50%,#ef4444 100%);}
    .riskpointer{position:absolute;top:-6px;width:0;height:0;
      border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:12px solid #0f172a}
    .risklegend{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    .actions li{margin:4px 0}
  </style>
</head>
<body>
  <div class="overlay">
    <header>
      <div class="brand"><h1>PredictWell <span>Health.ai</span></h1></div>
      <nav>
        <a href="/eldercare.html">Eldercare</a>
        <a href="/athletics.html">Athletics</a>
      </nav>
    </header>

    <div class="card">
      <h2>Eldercare Sentinel — Weekly Check-In</h2>

      <label>Name</label>
      <input id="name" type="text" placeholder="e.g., Pat Quinn" />

      <label>Age</label>
      <input id="age" type="number" min="30" max="120" placeholder="79" />

      <label>Avg nightly SpO₂ (%)</label>
      <input id="avg_spo2" type="number" step="0.1" min="50" max="100" placeholder="94.5" />

      <label>HRV (RMSSD, ms)</label>
      <input id="hrv_rmssd" type="number" step="1" placeholder="18" />

      <label>Resting HR (bpm)</label>
      <input id="resting_hr" type="number" step="1" placeholder="70" />

      <label>Avg sleep (hours)</label>
      <input id="sleep_hours" type="number" step="0.1" placeholder="7" />

      <label>Avg daily steps</label>
      <input id="steps_daily" type="number" step="1" placeholder="3000" />

      <label><input id="gait_concern" type="checkbox" /> Any balance or dizziness issues?</label>
      <label><input id="cognitive_flags" type="checkbox" /> Any memory or attention concerns?</label>

      <label>Notes (optional)</label>
      <textarea id="notes" placeholder="Any changes this week?"></textarea>

      <div>
        <button class="primary" id="submitBtn">Submit Check-In</button>
        <button class="ghost" id="pingBtn">Ping Backend</button>
      </div>
    </div>

    <div class="card">
      <h3>Results</h3>
      <!-- Friendly results -->
      <div id="resultView" class="results-wrap">
        <p class="muted">Submit to see a friendly summary.</p>
      </div>
      <!-- Raw JSON for debugging -->
      <details class="debug">
        <summary>Raw JSON</summary>
        <pre id="output">{ }</pre>
      </details>
    </div>

    <footer>© <span id="year"></span> PredictWell Health.ai — Eldercare Sentinel</footer>
  </div>

  <script>
    const BASE_API = 'https://predictwell-backend-ai.onrender.com';

    // --- Risk / Actions heuristics (simple & transparent) ---
    function eldercareRiskScore(d){
      const m = d.metrics || {};
      const f = d.flags || {};
      let score = 0;

      // Weighting (0–100)
      if(m.spo2_avg && m.spo2_avg < 92) score += (92 - m.spo2_avg) * 3;      // up to ~60
      if(m.hrv_rmssd && m.hrv_rmssd < 20) score += (20 - m.hrv_rmssd) * 1.5; // up to ~30
      if(m.resting_hr && m.resting_hr > 80) score += (m.resting_hr - 80) * 1;
      if(m.sleep_hours && m.sleep_hours < 6) score += (6 - m.sleep_hours) * 4;
      if(m.steps_daily && m.steps_daily < 3000) score += ((3000 - m.steps_daily)/1000) * 4;
      if(f.gait_concern) score += 12;
      if(f.cognitive_flags) score += 12;

      score = Math.max(0, Math.min(100, Math.round(score)));
      let band = 'Low', color='ok';
      if(score >= 66){ band='High'; color='err'; }
      else if(score >= 33){ band='Moderate'; color='warn'; }
      return { score, band, color };
    }

    function eldercareActions(d){
      const m = d.metrics || {};
      const f = d.flags || {};
      const acts = [];
      if(m.spo2_avg && m.spo2_avg < 92) acts.push('Check SpO₂ device fit; consider humidifier and deep-breathing twice daily.');
      if(m.hrv_rmssd && m.hrv_rmssd < 20) acts.push('Add 5–10 min evening relaxation (box breathing, light stretching).');
      if(m.resting_hr && m.resting_hr > 80) acts.push('Hydrate and take a light 10-min walk; avoid late caffeine.');
      if(m.sleep_hours && m.sleep_hours < 6.5) acts.push('Aim for 15–30 more minutes of sleep tonight.');
      if(m.steps_daily && m.steps_daily < 3500) acts.push('Add a 10-minute stroll after lunch.');
      if(f.gait_concern) acts.push('Perform 2× daily balance support (wall stand, heel-to-toe). Consider PT screen.');
      if(f.cognitive_flags) acts.push('Schedule a short cognitive check-in (orientation, recall).');
      if(!acts.length) acts.push('Keep current routine. Great job!');
      return acts.slice(0,5);
    }

    // --- View renderer ---
    function renderEldercareView(data){
      const wrap = document.getElementById('resultView');
      if(!data){ wrap.innerHTML = '<p class="muted">No data.</p>'; return; }

      const y = (v, s='') => (v===null || v===undefined || v==='') ? '—' : (s?`${v}${s}`:v);
      const pill = (label, on) => `<span class="pill ${on?'warn':'ok'}">${label}: ${on?'Yes':'No'}</span>`;

      const name = data.name ?? '—';
      const age = (data.age ?? '') === '' ? '—' : data.age;
      const ts  = data.timestamp ? new Date(data.timestamp).toLocaleString() : '—';

      const m = data.metrics || {};
      const f = data.flags   || {};
      const risk = eldercareRiskScore(data);
      const actions = eldercareActions(data);

      wrap.innerHTML = `
        <div class="section">
          <h4>Risk Summary</h4>
          <div class="risk">
            <div class="riskband">
              <div class="riskpointer" style="left: calc(${risk.score}% - 7px)"></div>
            </div>
            <div class="risklegend"><span>Low</span><span>Moderate</span><span>High</span></div>
            <div class="kv" style="margin-top:6px"><b>Score</b><span><span class="pill ${risk.color}">${risk.band}</span> &nbsp; ${risk.score}/100</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Summary</h4>
          <div class="grid">
            <div class="kv"><b>Name</b><span>${name}</span></div>
            <div class="kv"><b>Age</b><span>${age}</span></div>
            <div class="kv"><b>Record ID</b><span>${y(data.id)}</span></div>
            <div class="kv"><b>Submitted</b><span>${ts}</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Vitals</h4>
          <div class="grid">
            <div class="kv"><b>SpO₂ (avg)</b><span>${y(m.spo2_avg, '%')}</span></div>
            <div class="kv"><b>HRV (RMSSD)</b><span>${y(m.hrv_rmssd, ' ms')}</span></div>
            <div class="kv"><b>Resting HR</b><span>${y(m.resting_hr, ' bpm')}</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Sleep & Activity</h4>
          <div class="grid">
            <div class="kv"><b>Sleep</b><span>${y(m.sleep_hours, ' hrs')}</span></div>
            <div class="kv"><b>Steps</b><span>${y(m.steps_daily)}</span></div>
          </div>
        </div>

        <div class="section">
          <h4>Flags</h4>
          <div class="grid">
            <div>${pill('Balance/Gait', !!f.gait_concern)}</div>
            <div>${pill('Cognitive', !!f.cognitive_flags)}</div>
          </div>
        </div>

        <div class="section">
          <h4>Next Actions</h4>
          <ul class="actions">
            ${actions.map(a=>`<li>${a}</li>`).join('')}
          </ul>
        </div>

        <div class="section">
          <h4>Notes</h4>
          <div class="kv" style="grid-column:1/-1"><b>Notes</b><span>${y(data.notes)}</span></div>
        </div>
      `;
    }

    // --- Raw JSON (debug) ---
    const out = (obj) => {
      const el = document.getElementById('output');
      el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    };

    async function ping() {
      try {
        const r = await fetch(`${BASE_API}/healthz`, { cache:'no-store' });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();
        out(d);
      } catch (e) { out({ error:String(e) }); }
    }

    // Submit and show friendly summary immediately
    async function submitCheckin() {
      const payload = {
        name: document.getElementById('name').value,
        age: Number(document.getElementById('age').value),
        metrics: {
          spo2_avg: Number(document.getElementById('avg_spo2').value),
          hrv_rmssd: Number(document.getElementById('hrv_rmssd').value),
          resting_hr: Number(document.getElementById('resting_hr').value),
          sleep_hours: Number(document.getElementById('sleep_hours').value),
          steps_daily: Number(document.getElementById('steps_daily').value)
        },
        flags: {
          gait_concern: document.getElementById('gait_concern').checked,
          cognitive_flags: document.getElementById('cognitive_flags').checked
        },
        notes: document.getElementById('notes').value,
        timestamp: new Date().toISOString()
      };

      try {
        renderEldercareView(payload); // optimistic preview
        const res = await fetch(`${BASE_API}/eldercare/checkin`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const server = await res.json(); // { id } expected
        const display = { id: server?.id ?? null, ...payload };
        renderEldercareView(display);
        out(display);
      } catch (err) {
        renderEldercareView(null);
        out({ error:String(err) });
      }
    }

    document.getElementById('submitBtn').addEventListener('click', submitCheckin);
    document.getElementById('pingBtn').addEventListener('click', ping);
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
